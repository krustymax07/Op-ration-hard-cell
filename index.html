<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Puzzle Morse â€” CORSAIR</title>
<style>
  :root { --win: #34d399; }
  body { font-family: Inter, system-ui, Arial; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; gap:1rem; padding:1rem; background:#0b1220; color:#e6eef8; overflow-x:hidden; }
  .box { background: rgba(255,255,255,0.03); padding:1.2rem; border-radius:12px; box-shadow: 0 6px 20px rgba(2,6,23,0.6); width:100%; max-width:620px; text-align:center; transition: box-shadow .4s, transform .4s; }
  .word { font-size:2rem; letter-spacing:0.14em; font-weight:700; margin:0.5rem 0; }
  .morse { font-family: monospace; color:#bfe3ff; }
  .btn { padding:0.6rem 1rem; border-radius:8px; cursor:pointer; background:#2dd4bf; color:#012; border:0; font-weight:600; }
  .danger { background:#ff6b6b; color:white; }
  .unlocked { background: linear-gradient(90deg,#fbc2eb,#a6c1ee); color:#012; padding:1rem; border-radius:10px; font-weight:800; }
  small { color:#9fb0c7; }
  .grid { display:grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 8px; }
  .cell { padding: 10px 0; border-radius: 10px; background: rgba(255,255,255,0.06); }

  /* Effet victoire */
  .box.win {
    box-shadow: 0 0 0 4px rgba(52,211,153,.35), 0 12px 30px rgba(0,0,0,.5);
    animation: bounce .7s ease;
  }
  @keyframes bounce {
    0% { transform: scale(1); }
    30% { transform: scale(1.06); }
    60% { transform: scale(0.98); }
    100% { transform: scale(1); }
  }

  /* Confettis */
  .confetti {
    position: fixed;
    top: -10px;
    width: 10px; height: 14px;
    opacity: .9;
    transform: translateY(-20vh) rotate(0);
    animation: fall linear forwards;
    pointer-events: none;
    z-index: 50;
  }
  @keyframes fall {
    to { transform: translateY(110vh) rotate(720deg); opacity: 1; }
  }
</style>
</head>
<body>

<div class="box" id="panel">
  <h2> Code DÃ©verrouillage</h2>
  <p><small>Scanne les QR pour ouverture de la porte.</small></p>


  <div>
    <div>Morse reÃ§u : <span id="morse" class="morse">â€”</span></div>
    <div class="word" id="assembled">_ _ _ _ _ _ _</div>
    <div class="grid" id="posGrid"></div>
    <div id="status">Statut : <span id="statustext">En attente</span></div>
  </div>

  <div style="margin-top:1rem;">
    <input id="manual" placeholder="Entrer morse .- / -..." style="padding:0.6rem 0.6rem; width:60%; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit;">
    <button id="addBtn" class="btn">Ajouter</button>
  </div>

  <div style="margin-top:1rem; display:flex; gap:0.5rem; justify-content:center;">
    <button id="resetBtn" class="btn danger">RÃ©initialiser</button>
  </div>

  <div id="unlockArea" style="margin-top:1rem;"></div>
  

<script>
const TARGET_WORD = "CORSAIR";
const LETTERS = TARGET_WORD.length;

const MORSE_TO_CHAR = {
  ".-":"A","-...":"B","-.-.":"C","-..":"D",".":"E","..-.":"F","--.":"G","....":"H","..":"I",
  ".---":"J","-.-":"K",".-..":"L","--":"M","-.":"N","---":"O",".--.":"P","--.-":"Q",
  ".-.":"R","...":"S","-":"T","..-":"U","...-":"V",".--":"W","-..-":"X","-.--":"Y","--..":"Z",
  "-----":"0",".----":"1","..---":"2","...--":"3","....-":"4",".....":"5","-....":"6","--...":"7","---..":"8","----.":"9"
};

let assembled = new Array(LETTERS).fill(null);

function renderAssembled(){
  const el = document.getElementById('assembled');
  el.textContent = assembled.map(c => c ? c : "_").join(" ");
  const grid = document.getElementById('posGrid');
  grid.innerHTML = "";
  for(let i=0;i<LETTERS;i++){
    const d = document.createElement('div');
    d.className = "cell";
    d.textContent = (i+1)+": "+(assembled[i] || "_");
    grid.appendChild(d);
  }
}

function saveState(){ localStorage.setItem('puzzle_state', JSON.stringify(assembled)); }
function loadState(){ const s = localStorage.getItem('puzzle_state'); if(s){ assembled = JSON.parse(s); renderAssembled(); checkUnlocked(); } }

function decodeMorse(morse){
  morse = morse.trim();
  return MORSE_TO_CHAR[morse] || null;
}

function addLetter(letter, pos=null){
  if(pos!==null){
    const idx = pos-1;
    if(idx>=0 && idx<LETTERS){ assembled[idx] = letter; }
  } else {
    const idx = assembled.findIndex(x => x === null);
    if(idx !== -1) assembled[idx] = letter;
  }
  renderAssembled();
  saveState();
  checkUnlocked();
}

function handleUrlParam(){
  const p = new URLSearchParams(window.location.search);
  if(p.has('m')){
    const morse = p.get('m');
    document.getElementById('morse').textContent = morse;
    const ch = decodeMorse(morse);
    const st = document.getElementById('statustext');
    let pos = null;
    if(p.has('pos')){ pos = parseInt(p.get('pos'),10); }
    if(ch){
      st.textContent = pos ? `DÃ©codÃ© '${ch}' â†’ placÃ© en position ${pos}.` : `DÃ©codÃ© '${ch}' â€” ajoutÃ©.`;
      addLetter(ch, pos);
    } else {
      st.textContent = "Morse inconnu / illisible.";
    }
    history.replaceState({}, document.title, window.location.pathname);
  }
}

function checkUnlocked(){
  if(assembled.every(x => x !== null)){
    const current = assembled.join('').toUpperCase();
    if(current === TARGET_WORD){ showUnlocked(); }
    else { document.getElementById('unlockArea').innerHTML = `<div style="padding:0.6rem;border-radius:8px;background:rgba(255,255,255,0.03)">Mot complet : <strong>${current}</strong> â€” incorrect.</div>`; }
  } else {
    document.getElementById('unlockArea').innerHTML = '';
  }
}

/* ====== ANIMATION + SON DE VICTOIRE ====== */
function showUnlocked(){
  // Message visuel
  document.getElementById('unlockArea').innerHTML =
    `<div class="unlocked">ðŸ”“ Porte dÃ©verrouillÃ©e !<br>Mot : <strong>${assembled.join('')}</strong></div>`;

  // Effet halo + rebond
  const panel = document.getElementById('panel');
  panel.classList.add('win');
  setTimeout(()=> panel.classList.remove('win'), 900);

  // Confettis
  createConfetti(120);

  // Son de victoire
  playWinSound();
}

// confettis simples
function createConfetti(count=100){
  const colors = ["#f87171","#fbbf24","#34d399","#60a5fa","#a78bfa","#f472b6"];
  for(let i=0;i<count;i++){
    const p = document.createElement('div');
    p.className = 'confetti';
    const size = 6 + Math.random()*8;
    p.style.width = size + 'px';
    p.style.height = (size*1.4) + 'px';
    p.style.left = (Math.random()*100) + 'vw';
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    p.style.animationDuration = (2.5 + Math.random()*2.2) + 's';
    p.style.animationDelay = (Math.random()*0.6) + 's';
    p.style.transform = `translateY(-20vh) rotate(${Math.random()*180}deg)`;
    document.body.appendChild(p);
    setTimeout(()=> p.remove(), 4000);
  }
}

/* Petite fanfare WebAudio : trois notes en montÃ©e + accord final */
function playWinSound(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const now = ctx.currentTime;
    const master = ctx.createGain();
    master.gain.setValueAtTime(0.0001, now);
    master.connect(ctx.destination);
    master.gain.exponentialRampToValueAtTime(0.6, now + 0.02); // fade in lÃ©ger

    // fonction pour crÃ©er une note courte
    function note(freq, t0, dur=0.18, type='sine'){
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, t0);
      gain.gain.setValueAtTime(0.0001, t0);
      gain.gain.exponentialRampToValueAtTime(0.5, t0 + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
      osc.connect(gain).connect(master);
      osc.start(t0);
      osc.stop(t0 + dur + 0.02);
    }

    // Petite montÃ©e (do-mi-sol environ)
    note(523.25, now + 0.00, 0.18, 'triangle'); // C5
    note(659.25, now + 0.20, 0.18, 'triangle'); // E5
    note(783.99, now + 0.40, 0.18, 'triangle'); // G5

    // Accord final un peu plus long
    function chord(freqs, t0, dur=0.5){
      freqs.forEach(f => note(f, t0, dur, 'sawtooth'));
    }
    chord([523.25, 659.25, 783.99], now + 0.62, 0.6);

    // fade-out global
    master.gain.exponentialRampToValueAtTime(0.0001, now + 1.4);
    setTimeout(()=> ctx.close(), 1600);
  }catch(e){
    // si WebAudio indisponible, on ignore
  }
}
/* ====== FIN ANIMATION + SON ====== */

document.getElementById('addBtn').addEventListener('click', ()=>{
  const m = document.getElementById('manual').value.trim();
  const ch = decodeMorse(m);
  if(ch){ addLetter(ch); document.getElementById('manual').value=''; }
  else { alert('Morse non reconnu.'); }
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(!confirm('RÃ©initialiser le puzzle ?')) return;
  assembled = new Array(LETTERS).fill(null);
  saveState();
  renderAssembled();
  document.getElementById('morse').textContent = "â€”";
  document.getElementById('statustext').textContent = "RÃ©initialisÃ©";
  document.getElementById('unlockArea').innerHTML = '';
});

renderAssembled();
loadState();
handleUrlParam();
</script>

</body>
</html>
